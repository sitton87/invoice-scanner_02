graph TD
    A[ğŸš€ ×”×¤×¢×œ×ª main.py] --> B[ğŸ“‹ ×˜×¢×™× ×ª GUI - ui.py]
    
    B --> C{ğŸ”§ ×‘×“×™×§×ª API Key<br/>config.validate_api_key}
    C -->|âŒ ××™×Ÿ ××¤×ª×—| D[âš ï¸ ×”×–×”×¨×” ×‘×œ×•×’]
    C -->|âœ… ××¤×ª×— ×ª×§×™×Ÿ| E[âœ… ××¦×™×’ ×”×•×“×¢×” ×‘×œ×•×’]
    
    D --> F[ğŸ¯ ×××©×§ ××•×›×Ÿ ×œ×©×™××•×©]
    E --> F
    
    F --> G[ğŸ“ ×œ×—×™×¦×” ×¢×œ 'Select Invoice File']
    G --> H[ğŸ“‚ filedialog.askopenfilename<br/>×‘×—×™×¨×ª ×§×•×‘×¥]
    H --> I[ğŸ“„ ×”×¦×’×ª ×©× ×§×•×‘×¥ + ×”×¤×¢×œ×ª ×›×¤×ª×•×¨ Process]
    
    I --> J[âš™ï¸ ×‘×—×™×¨×ª ×”×’×“×¨×•×ª]
    J --> K[ğŸ“Š Processing Mode:<br/>â€¢ OCR Mode âœ…<br/>â€¢ Image Mode]
    J --> L[ğŸ“‹ Sections:<br/>â€¢ INTRO âœ…<br/>â€¢ MAIN âœ…]
    
    K --> M[ğŸš€ ×œ×—×™×¦×” ×¢×œ 'Process Invoice']
    L --> M
    
    M --> N[ğŸ”„ start_processing<br/>â€¢ ×”×©×‘×ª×ª ×›×¤×ª×•×¨×™×<br/>â€¢ ×”×¤×¢×œ×ª progress bar]
    
    N --> O[ğŸ§µ threading.Thread<br/>process_in_background]
    
    O --> P{ğŸ”€ ×‘×—×™×¨×ª ××¦×‘ ×¢×™×‘×•×“}
    
    P -->|ğŸ” OCR + INTRO + MAIN| Q1[ğŸ“œ full_processor.py<br/>FullInvoiceProcessor]
    P -->|ğŸ–¼ï¸ Image + INTRO + MAIN| Q1
    P -->|ğŸ” OCR + MAIN ×‘×œ×‘×“| Q2[ğŸ” ocr_processor.py<br/>OCRProcessor]
    P -->|ğŸ–¼ï¸ Image + MAIN ×‘×œ×‘×“| Q3[ğŸ“· processor.py<br/>InvoiceProcessor]
    
    Q1 --> R1[ğŸ“‹ intro_analyzer.py<br/>IntroAnalyzer]
    Q1 --> R2[ğŸ›’ ×¢×™×‘×•×“ MAIN Items]
    
    Q2 --> S1[ğŸ” OCR: Tesseract]
    Q2 --> S2[ğŸ¤– Claude API - MAIN]
    
    Q3 --> T1[ğŸ“· PIL + OpenCV]
    Q3 --> T2[ğŸ¤– Claude Vision API - MAIN]
    
    R1 --> U[ğŸ“¤ ×ª×©×•×‘×” ×œ-GUI]
    R2 --> U
    S2 --> U
    T2 --> U
    
    U --> V[ğŸ“Š show_results]
    V --> W[ğŸ“„ ×”×¦×’×ª JSON ×‘×œ×•×’]
    V --> X[ğŸ’¾ ×©××™×¨×ª ×§×•×‘×¥ JSON]
    V --> Y[ğŸ”˜ ×”×¤×¢×œ×ª 'Open Output Folder']
    
    Y --> Z[ğŸ“‚ ×¤×ª×™×—×ª ×ª×™×§×™×™×ª ×¤×œ×˜]
    W --> AA[ğŸ“‹ Copy Log / ğŸ—‘ï¸ Clear Results]

    style A fill:#e1f5fe
    style Q1 fill:#c8e6c9
    style Q2 fill:#fff3e0
    style Q3 fill:#fce4ec
    style U fill:#f3e5f5






    [User clicks "Process" in UI]
          â”‚
          â–¼
      ui.py (GUI)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ×§×•×¨×: process_full_invoice(
        file_path, 
        process_intro=âœ“/âœ—, 
        process_main=âœ“/âœ—, 
        use_ocr=False)
          â”‚
          â–¼
 full_processor.process_full_invoice
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1) _prepare_image_for_analysis(file)  â† use_ocr=False
     (×‘×©×œ×‘ ×–×” ×¨×§ ××¢×‘×™×¨ × ×ª×™×‘; ×¢×™×‘×•×“ ×ª××•× ×” ×›×‘×“ × ×¢×©×” ×‘-processor.py)
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚             â”‚
          â–¼             â–¼
 (×× INTRO=âœ“)       (×× MAIN=âœ“)
 IntroAnalyzer       InvoiceProcessor
 .analyze_intro(     .process_invoice(
   image_path=...)     file_path,...)
   â”‚                    â”‚
   â”‚                    â”œâ”€ ×× PDF â†’ _pdf_to_image()
   â”‚                    â”‚     â€¢ ×¨×™× ×“×•×¨ ×›×œ ×¢××•×“ ×¢× PyMuPDF
   â”‚                    â”‚     â€¢ ××™×—×•×“ ×× ×›×™ ×œ×ª××•× ×” ××—×ª
   â”‚                    â”‚     â€¢ ××•×¤×˜×™××™×–×¦×™×” (×’×•×“×œ/××™×›×•×ª)
   â”‚                    â””â”€ ×× ×ª××•× ×” â†’ _optimize_image()
   â”‚
   â–¼                    â–¼
 ×©×œ×™×—×” ×œ-CLAUDE       ×©×œ×™×—×” ×œ-CLAUDE
 (image + prompt)     (image + SYSTEM_PROMPT + USER_PROMPT)
   â”‚                    â”‚
   â–¼                    â–¼
 ×—×™×œ×•×¥ JSON           ×—×™×œ×•×¥ JSON
 + × ×™×§×•×™/×•×œ×™×“×¦×™×”      (_extract_json_from_response)
 (metadata:            â”‚
  extracted_fields,     â–¼
  completeness, ...)   result_json
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
        ××™×–×•×’ ×ª×•×¦××•×ª + Summary
        (processing_time, sections,
         main.total_lines ×•×›×•')
                 â”‚
                 â–¼
      _save_full_result(...)  â†’  ×›×ª×™×‘×ª JSON
      (get_custom_output_filename)
                 â”‚
                 â–¼
       ×”×—×–×¨×” ×œÖ¾UI + ×”×•×“×¢×ª ×”×¦×œ×—×”
